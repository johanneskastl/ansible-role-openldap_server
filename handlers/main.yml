---
# openldap_server/handlers/main.yml

#
# handlers triggered by package installation
#
- name: 'Stop the OpenLDAP server service'
  service:
    name: "{{ openldap_server_service }}"
    state: 'stopped'
    masked: 'false'
  tags:
    - 'installation'

- name: 'Remove database files'
  file:
    path: "{{ item }}"
    state: 'absent'
  loop:
    - "{{ path_to_openldap_var_directory }}data.mdb"
    - "{{ path_to_openldap_var_directory }}lock.mdb"
  tags:
    - 'installation'

- name: 'Remove file olcDatabase={2}hdb.ldif'
  file:
    path: '/etc/openldap/slapd.d/cn=config/olcDatabase={2}hdb.ldif'
    state: 'absent'
  when: 'ansible_os_family == "RedHat"'
  tags:
    - 'installation'

- name: 'Create olcDatabase={2}mdb.ldif'
  template:
    src: 'olcDatabase2mdb.ldif.j2'
    dest: '/etc/openldap/slapd.d/cn=config/olcDatabase={2}mdb.ldif'
    owner: "{{ openldap_user }}"
    group: "{{ openldap_group }}"
    mode: '0600'
  when: 'ansible_os_family == "RedHat"'
  tags:
    - 'installation'

#
# handlers triggered by configuration changes
#
- name: 'Fix permissions on database files'
  file:
    path: "{{ item }}"
    owner: "{{ openldap_user }}"
    group: "{{ openldap_group }}"
    mode: '0600'
  loop:
    - "{{ path_to_openldap_var_directory }}data.mdb"
    - "{{ path_to_openldap_var_directory }}lock.mdb"
  ignore_errors: "{{ ansible_check_mode }}"
  tags:
    - 'configuration'
  notify:
    - 'Restart the OpenLDAP server service'

- name: 'Restart the OpenLDAP server service'
  service:
    name: "{{ openldap_server_service }}"
    state: 'restarted'
  tags:
    - 'configuration'

- name: 'Set olcRootPW via ldapmodify'
  command:
    cmd: 'ldapmodify -Q -Y EXTERNAL -H ldapi:/// -f /root/OpenLDAP_configuration_via_ansible/rootDN_password_hash_base64.ldif'
  when: 'grep_for_olcRootPW.stdout == ""'
  tags:
    - 'configuration'
